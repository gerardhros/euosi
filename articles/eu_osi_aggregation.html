<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>EU OSI aggregation • euosi</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="EU OSI aggregation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">euosi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/description_osi_crops_table.html">Description of osi_crops table</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_aggregation.html">EU OSI aggregation</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_for_acidity.html">EU OSI soil acidity</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_for_magnesium.html">EU OSI for magnesium</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_for_nitrogen.html">EU OSI for nitrogen</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_for_phosphor.html">EU OSI for phosphor</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_for_potassium.html">EU OSI for potassium</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_introduction.html">EU OSI introduction</a></li>
    <li><a class="dropdown-item" href="../articles/eu_osi_variables.html">EU OSI variables</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>EU OSI aggregation</h1>
                        <h4 data-toc-skip class="author">Gerard H
Ros</h4>
            
            <h4 data-toc-skip class="date">2025-08-21</h4>
      

      <div class="d-none name"><code>eu_osi_aggregation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The euosi is a framework that takes a multitude of soil parameters
and variables from agricultural fields and ultimately gives a single
value expressing the soil quality of that field, following the
methodology developed by <a href="https://pubs.acs.org/doi/10.1021/acs.est.2c04516#" class="external-link">Ros et
al. (2022)</a> and as implemented in the <a href="https://agrocares.github.io/Open-Bodem-Index-Calculator/" class="external-link">OBIC R
package</a>. To take this multitude of measured, modeled and calculated
values to a single value between 0 and 1, representing a holistic score
for the soil health, three aggregation steps take place as illustrated
below (source: OBIC).</p>
<p><br></p>
<div class="figure">
<img src="../articles/obic_score_integratie.png" alt="Figure 1. Graphic representation of how measured soil properties are aggregated to scores." width="85%" height="85%"><p class="caption">
Figure 1. Graphic representation of how measured soil properties are
aggregated to scores.
</p>
</div>
<p>There is no scientific principle dictating how this aggregation
should be done and there are several ways to do the aggregation. For
example; averaging, linearly weighted averaging, logarithmically
weighted averaging. The last one is used in <code>OBIC</code> and also
in the <code>euosi</code> package. This vignette dives deeper into the
three aggregation steps within the framework and will explain why
logarithmically weighted aggregation is chosen. <br><br></p>
</div>
<div class="section level2">
<h2 id="aggregation">Aggregation<a class="anchor" aria-label="anchor" href="#aggregation"></a>
</h2>
<div class="section level3">
<h3 id="pre-processing">Pre-processing<a class="anchor" aria-label="anchor" href="#pre-processing"></a>
</h3>
<p>After calculating soil function scores and in prior to the
aggregation procedure, a reformatting step takes place. The reformatting
step consists of the following tasks:</p>
<ul>
<li>it is assessed which indicators are relevant for a field given its
soil type and crop category using a fixed table hard coded (for the
moment) in <code>osi_field</code> (lines 251-254).</li>
<li>year numbers are assigned from 1 to n with one being the most recent
year (used later for the aggregation over years)</li>
<li>a molten data.table is created with all indicators in a single
column and soil type, crop category and year as identifying
variables</li>
<li>indicators are assigned to categories (chemical, physical,
biological, environment)</li>
<li>the number of indicators per category is counted (used later for the
aggregation over categories)</li>
<li>a correction factor per score is calculated based on the height of
the score (used later for the aggregation within each category)</li>
<li>soil function scores irrelevant to the land use are set to -999</li>
</ul>
<p>This procedures is coded inside <code>osi_field</code> function, and
illustrated below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  </span>
<span>  <span class="co"># Step 3 Reformat dt given weighing per indicator and prepare for aggregation  ------------------</span></span>
<span>    </span>
<span>    <span class="co"># make a data.table for indicators that are not relevant for aggregation for a given crop</span></span>
<span>    <span class="co"># in this example: wind erosion has no impact on soil loss when grassland is there</span></span>
<span>    <span class="co"># a negative weight value excludes this indicator from the aggregation process</span></span>
<span>    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span>crop_cat1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'grasland'</span><span class="op">)</span>,</span>
<span>                    indicator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'i_p_wef'</span><span class="op">)</span>,</span>
<span>                    weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># select all indicators used for scoring, only for I_C, I_P, I_B and I_B</span></span>
<span>    <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^ID$|^i_c|^i_p|^i_b|^i_e|year|crop_cat1'</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># melt dt and assign main categories for OBI</span></span>
<span>    <span class="va">dt.melt</span> <span class="op">&lt;-</span> <span class="fu">melt</span><span class="op">(</span><span class="va">dt</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">mget</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                    id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'year'</span>, <span class="st">'ID'</span>,<span class="st">'crop_cat1'</span><span class="op">)</span>,</span>
<span>                    variable.name <span class="op">=</span> <span class="st">'indicator'</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># remove the indicators that have a NA value</span></span>
<span>    <span class="va">dt.melt</span> <span class="op">&lt;-</span> <span class="va">dt.melt</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># add main categories relevant for aggregating</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_c|^i_p|^i_b'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_prod'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'excess'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_env'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'nleac|water'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_env'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'carbon'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_env'</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># add sub categories relevant for aggregating</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_c'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'chemistry'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_p'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'physics'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_b'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'biology'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'excess'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'nutcycle'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'nleac|water'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'water'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'carbon'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'climate'</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Determine amount of indicators per (sub)category</span></span>
<span>    <span class="va">dt.melt.ncat</span> <span class="op">&lt;-</span> <span class="va">dt.melt</span><span class="op">[</span><span class="va">year</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncat <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>,by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">cat1</span>,<span class="va">cat2</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># add weighing factor to indicator values</span></span>
<span>    <span class="va">dt.melt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dt.melt</span>,</span>
<span>                     <span class="va">w</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">crop_cat1</span>,<span class="va">indicator</span>,<span class="va">weight</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                     by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'crop_cat1'</span>,<span class="st">'indicator'</span><span class="op">)</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># calculate correction factor for indicator values</span></span>
<span>    <span class="co"># low values have more impact than high values, a factor 5</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span>,<span class="va">cf</span> <span class="op">:=</span> <span class="fu">euosi</span><span class="fu">::</span><span class="fu"><a href="../reference/cf_ind_importance.html">cf_ind_importance</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># calculate weighted value for crop category</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span>,<span class="va">value.w</span> <span class="op">:=</span> <span class="va">value</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="va">weight</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,<span class="va">value.w</span> <span class="op">:=</span> <span class="op">-</span><span class="fl">999</span><span class="op">]</span></span>
<span>    </span>
<span>    </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregation-within-category">Aggregation within category<a class="anchor" aria-label="anchor" href="#aggregation-within-category"></a>
</h3>
<p>The indicators within each category are aggregated to a single score
per category (chemical, physical, biological, nutcycle, water and
climate) using the correction factor (<em>vcf</em>) calculated
previously using <code><a href="../reference/cf_ind_importance.html">cf_ind_importance()</a></code>. This correction
factor <em>vcf</em> gives a higher weight to indicators with a lower
score, as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>c</mi><mi>f</mi><mo>=</mo><mn>1</mn><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>+</mo><mn>0.2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
vcf = 1/(I+0.2)
</annotation></semantics></math> where <em>I</em> is the score of the
indicator. This way, the lowest indicator, supposedly also the most
limiting factor for crop production, becomes more important.
Consequently, improving a low scoring indicator by 0.1 has a greater
impact on the aggregated category score than improving a high scoring
indicator by the same amount, making it more worthwhile to invest in the
poorest and most limiting indicator.</p>
<p>Subsequently, the score of each category is computed by summing up
the weighted values (scaled by the sum of all weights) of all soil
indicators within the category:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>i</mi></msub><mfrac><mrow><mi>v</mi><mi>c</mi><msub><mi>f</mi><mi>i</mi></msub></mrow><mrow><munder><mo>∑</mo><mi>i</mi></munder><mi>v</mi><mi>c</mi><msub><mi>f</mi><mi>i</mi></msub></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
S =  \sum_{i}(I_{i} \frac{vcf_{i}}{\sum_{i}vcf_{i}})
</annotation></semantics></math> where <em>S</em> is the score of the
category, <em>vcf</em><sub>i</sub> is the weighing factor of the
indicator <em>i</em>, <em>I</em><sub>i</sub> is the score of the
indicator <em>i</em>. This gives a single score for each of the five
indicator categories (chemical, physical, biological, management, and
environmental) for a specific year.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    </span>
<span> <span class="co"># subset dt.melt for relevant columns only</span></span>
<span> <span class="va">out.score</span> <span class="op">&lt;-</span>  <span class="va">dt.melt</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">cat1</span>,<span class="va">cat2</span>, <span class="va">year</span>, <span class="va">cf</span>, value <span class="op">=</span> <span class="va">value.w</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span> <span class="co"># calculate weighted average per indicator category per year</span></span>
<span> <span class="va">out.score</span> <span class="op">&lt;-</span> <span class="va">out.score</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cf</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">value</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cf</span><span class="op">[</span><span class="va">value</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                          by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">cat2</span>,<span class="va">year</span><span class="op">)</span><span class="op">]</span></span>
<span>   </span>
<span> <span class="co"># for case that a cat has one indicator or one year and has NA</span></span>
<span> <span class="va">out.score</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="va">value</span> <span class="op">:=</span> <span class="op">-</span><span class="fl">999</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregation-over-years">Aggregation over years<a class="anchor" aria-label="anchor" href="#aggregation-over-years"></a>
</h3>
<p>To account for the entire crop rotation, <code>euosi</code>
aggregates scores of multiple years. For the aggregation over years,
another correction factor <em>ycf</em> is used to give more weight to
recent years on a logarithmic scale. OBIC set the maximum length of
period as 10 years, as crop rotation in the Netherlands are hardly ever
longer than 10 years. When data older than 10 years ago is used, then
those years get the same weight as 10 years ago. <em>ycf</em> is
formulated as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi>c</mi><mi>f</mi><mo>=</mo><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>12</mn><mo>−</mo><mi>m</mi><mi>i</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>y</mi><mo>,</mo><mn>10</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
ycf = ln(12 - min(y, 10))
</annotation></semantics></math> where <em>y</em> is the length of years
before the assessment. <em>y = 1</em> means the year for which the
assessment is conducted for (i.e. the most recent year).</p>
<p>This gives the correction factors for a period of eleven years as
follows (from the most recent years to 11 years before):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># create data</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">11</span></span>
<span>  <span class="va">cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">12</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cf</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2.398 2.303 2.197 2.079 1.946 1.792 1.609 1.386 1.099 0.693 0.693</span></span></code></pre></div>
<p>The most recent year carries about 3.5 times the weight of the tenth
year. Notice that years ten and eleven have the same correction factor
value, the minimum <em>ycf</em> value for a year is equal to that of
year ten.</p>
<p>More priority (weight) is given to recent years because they better
reflect the current situation. Additionally, changes in management or
soil properties have a more visible effect on the scores in the recent
years.</p>
<p>Aggregation of scores over years is done with the following two lines
of code. This is analogue to the aggregation procedure within each
category as described above (i.e. sum of weighted score, scaled by the
sum of all weighing factors).</p>
<p>The aggregation procedure is coded in the following lines.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>            </span>
<span>  <span class="co"># calculate correction factor per year; recent years are more important</span></span>
<span>  <span class="va">out.score</span><span class="op">[</span>,<span class="va">cf</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">12</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="fl">10</span>,<span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># calculate weighted average per indicator category per year</span></span>
<span>  <span class="va">out.score</span> <span class="op">&lt;-</span> <span class="va">out.score</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cf</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">value</span><span class="op">)</span><span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cf</span><span class="op">[</span><span class="va">value</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                         by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">cat2</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span></code></pre></div>
<p>This gives us a single score for each of the indicator categories
(chemical, physical, biological, nutcycle, water and climate), without
time dimension.</p>
</div>
<div class="section level3">
<h3 id="aggregation-to-single-osi-score">Aggregation to single OSI score<a class="anchor" aria-label="anchor" href="#aggregation-to-single-osi-score"></a>
</h3>
<p>The scores of indicator categories are aggregated to a single,
holistic, OSI score. The category scores are weighed logarithmically
based on the number of indicators underlying the category. The number of
indicators per category was retrieved previously with the line<br><code>dt.melt.ncat &lt;- dt.melt[year==1][,list(ncat = .N),by = .(ID, cat1)]</code>.<br>
Now its merged with our score data.table.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  </span>
<span><span class="co"># merge out with number per category</span></span>
<span>  <span class="va">out.score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">out.score</span>,<span class="va">dt.melt.ncat</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ID"</span>,<span class="st">"cat1"</span><span class="op">)</span>,all.x<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The correction factor for each category, <em>ccf</em>, are computed
based on the number of indicators as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>c</mi><mi>f</mi><mo>=</mo><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>n</mi><mi>c</mi><mi>a</mi><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
ccf = ln(ncat+1)
</annotation></semantics></math></p>
<p>where <em>ncat</em> is the number of the underlying indicators within
the category. The weights for categories with 1 to 10 indicators are:
0.69, 1.1, 1.39, 1.61, 1.79, 1.95, 2.08, 2.2, 2.3, 2.4. Thus, a category
based on 10 indicators affects the total score roughly 3.5 times more
than a category based on 1 indicator. The idea behind giving more weight
to categories with more underlying indicators sprouts from the idea that
such a category is better supported by measurable data and better
understood. Finally, the total OSI score is calculated by summing up the
weighted scores of 5 categories and dividing it by the sum of the
weighing factors, in the same way as the other 2 aggregation steps.</p>
<p>This aggregation procedure is coded in the following lines.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    </span>
<span>  <span class="co"># calculate weighing factor depending on number of indicators  </span></span>
<span>  <span class="va">out.score</span><span class="op">[</span>,<span class="va">cf</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ncat</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>  <span class="co"># calculate total score over all categories</span></span>
<span>  <span class="va">out.score.total</span> <span class="op">&lt;-</span> <span class="va">out.score</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>s_euosi_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">cf</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cf</span><span class="op">[</span><span class="va">value</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ID'</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span></code></pre></div>
<p>During the aggregation there is just a bit of code to format the
names of the scores.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    </span>
<span>    <span class="co"># add main categories relevant for aggregating</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_c|^i_p|^i_b'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_prod'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'excess'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_env'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'nleac|water'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_env'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'carbon'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat1</span> <span class="op">:=</span> <span class="st">'ess_env'</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># add sub categories relevant for aggregating</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_c'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'chemistry'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_p'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'physics'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^i_b'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'biology'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'excess'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'nutcycle'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'nleac|water'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'water'</span><span class="op">]</span></span>
<span>    <span class="va">dt.melt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'carbon'</span>,<span class="va">indicator</span><span class="op">)</span>, <span class="va">cat2</span> <span class="op">:=</span> <span class="st">'climate'</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># overwrite names</span></span>
<span>    <span class="fu">setnames</span><span class="op">(</span><span class="va">out.score.cat2</span>,</span>
<span>             old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'biology'</span>, <span class="st">'chemistry'</span>, <span class="st">'climate'</span>, <span class="st">'nutcycle'</span>, <span class="st">'physics'</span>, <span class="st">'water'</span><span class="op">)</span>,</span>
<span>             new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'s_euosi_prod_b'</span>,<span class="st">'s_euosi_prod_c'</span>,<span class="st">'s_euosi_clim'</span>,</span>
<span>                     <span class="st">'s_euosi_nutcycle'</span>,<span class="st">'s_euosi_prod_p'</span>,<span class="st">'s_euosi_water'</span><span class="op">)</span>,</span>
<span>             skip_absent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># overwrite names</span></span>
<span>    <span class="fu">setnames</span><span class="op">(</span><span class="va">out.score.cat1</span>,</span>
<span>             old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ess_prod'</span>,<span class="st">'ess_env'</span>,<span class="st">'ess_climate'</span>, <span class="st">'ess_nutcycle'</span>, <span class="st">'ess_water'</span><span class="op">)</span>,</span>
<span>             new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'s_euosi_ess_prod'</span>,<span class="st">'s_euosi_ess_env'</span>,<span class="st">'s_euosi_ess_clim'</span>,</span>
<span>                     <span class="st">'s_euosi_ess_nut'</span>,<span class="st">'s_euosi_ess_water'</span><span class="op">)</span>,</span>
<span>             skip_absent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="brief-recap">Brief recap<a class="anchor" aria-label="anchor" href="#brief-recap"></a>
</h3>
<ul>
<li>Soil functions with low scores gain more weight than ones with high
scores because these soil functions are supposed to be more limiting.
This makes it more worthwhile (both in reality as for the OBI score) to
invest in improving low scores</li>
<li>Values from recent years count more than values from long ago.
Recent years are more reflective of the current situation and it becomes
easier to see the effect of changes in management or soil properties in
subsequent years</li>
<li>Categories with more underlying indicators have more weight in
determining the total OSI score. This is because these indicators are
better understood and supported and may also be more important.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gerard Ros, Elise van Eynde, Sven Verweij.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
